@using Education.Data.Entities;
@using Education.ViewModel;
@using Microsoft.AspNetCore.Identity;
@model ContentVM
@inject UserManager<AppUser> UserManager

@{
    var CurrentUser = await UserManager.GetUserAsync(User);
}
    <!-- watch video section starts  -->
<section class="edit-comment" >
    <h1 class="heading" >edit comment</h1>
    <form action="" method="post" id="form" style="display:none">
        <input type="hidden" name="update_id" id="commentid">
        <textarea id="EditMessage" class="box" maxlength="1000" required placeholder="please enter your comment" cols="30" rows="10"></textarea>
        <div class="flex">
            <a id="cancel" class="inline-option-btn">cancel edit</a>
            <input type="button" id="updateComment" value="update now" name="update_now" class="inline-btn">
        </div>
    </form>
</section>



<section class="watch-video" >

        <div class="video-details">
        <video src="@Model.Video" class="video" controls poster="@Model.Thumb" ></video>
            <h3 class="title">@Model.Title</h3>
            <div class="info">
                <p><i class="fas fa-calendar"></i><span>@Model.DateCreated.ToString("dd-MM-yyyy")</span></p>
            <p><i class="fas fa-heart" id="likeCount"></i><span>@Model.Likes.Count</span></p>
            </div>
            <div class="tutor">
                <img src="@Model.AppUser.Image" alt="">
                <div>
                    <h3>@Model.AppUser.UserName</h3>
                    <span>Tutor</span>
                </div>
            </div>
        <form action="" method="post" class="flex" id="likeContainer">
                <a asp-action="Detail" asp-controller ="Playlist" asp-route-Id ="@Model.PlaylistId" class="inline-btn">view playlist</a>
                        
                @if (Model.UserLiked == 1)
                {
                <button type="button" id="likedButton"><i class="fas fa-heart"></i><span>liked</span></button>
                }
                else
                {
                <button type="button" id="likeButton"><i class="far fa-heart"></i><span>like</span></button>
                }
             
            </form> 
            <div class="description"><p>@Model.Description</p></div> 
        </div>
             
    </section>

    <!-- watch video section ends -->  
<section class="comments" id="commentContainer">

    <h1 class="heading">add a comment</h1>

    <form action="" method="post" class="add-comment">
        <textarea id="c_message"  required placeholder="write your comment..." maxlength="300" cols="30" rows="10"></textarea>
        <button type="button"  id="addComment" class="inline-btn">add comment</button>
    </form>

    <h1 id ="UserComment" class="heading">user comments</h1>

    <div class="show-comments" id="divComment">
    
        @foreach (var item in Model.Comments)
        {
                  <div class="box" >
                <div class="user">
                    <img src="@item.AppUser.Image" alt="">
                    <div>
                        <h3>@item.AppUser.UserName</h3>
                        <span>@item.DateCreated.ToString("dd-MM-yyyy")</span>
                    </div>
                </div>
                <p class="text">@item.Message</p>
                @if (item.UserId == CurrentUser.Id)
                {              
                    <form action="" method="post" class="flex-btn">
                      <button type="button" data-message="@item.Message" data-id="@item.Id" data-action="edit" class="inline-option-btn">edit comment</button>
                        <button type="button" id="@item.Id" data-action="delete" class="inline-delete-btn">delete comment</button>
                    </form>
                }
            </div>
        }
    </div>

</section>
<!-- comments section starts  -->

@section Scripts {


    <script>//cancel edit
        $(document).ready(function () {

            $("#cancel").click(function () {               
                $("#form").hide("box");
                $('html, body').animate({
                    scrollTop: $("#UserComment").offset().top
                },1000);
            });

        });

    </script>

     <script> // show form edit comment
        $(document).ready(function () {
            $("body").on("click", ".box button[data-action='edit']", function () {
                $("#form").show();
                $('html, body').animate({ 
                    scrollTop: 0            
                });
                var message = $(this).data("message");
                var id = $(this).data("id");
                $("#EditMessage").val(message);
                $("#commentid").val(id);       
            });

        });
    </script> 
    



    <script> // add comment
        $(document).ready(function () {

            $("#addComment").click(function () {
                $.ajax({
                    url: "/Content/AddComment",
                    type: "POST",
                    data: {
                        message: $("#c_message").val(),
                        ContentId: @Model.Id
                    },
                    success: function (data) {
                        $("#c_message").val("");
                        var date = moment(data.dateCreated).format("DD-MM-YYYY");
                        html = '<div class="box">' +
                            '<div class="user">' +
                            ' <img src="@CurrentUser.Image" alt="">' +
                            '<div>' +
                            ' <h3>@CurrentUser.UserName</h3>' +
                            '<span>' + date + '</span>' +
                            ' </div>' +
                            '</div>' +
                            ' <p class="text">' + data.message + '</p>' +
                            '<form action="" method="post" class="flex-btn">' +
                            '<button type="button" data-message="'+ data.message +'" data-md="'+ data.id +'" data-action="edit" class="inline-option-btn">edit comment</button>' +
                            '<button type="button" id="'+ data.id+'" data-action="delete" class="inline-delete-btn" >delete comment</button>' +
                            '</form>' +
                            '</div>'

                        $("#divComment").append(html);
                    },
                    error: function (error) {
                        alert("error");
                    }

                });
            });
        });
    </script>


    <script>
        //delete comment
        $(document).ready(function () {
            $("body").on("click", ".box button[data-action='delete']", function () {
                var clicked = $(this);
                $.ajax({
                    url: "/Content/DeleteComment",
                    type: "POST",
                    data: {
                        CommentId: this.id
                    },
                    success: function (data) {
                        clicked.closest('.box').hide("box");
                    },
                    error: function (error) {
                        console.error("false");
                    }

                });


            });

        });
    </script>

    <script> // add like
        $(document).ready(function () {

            $("#likeButton").click(function () {
                $("#likeButton").remove();
                $("#likedButton").show();
                $.ajax({
                    url: "/Content/AddLike",
                    type: "POST",
                    data: {
                        CurUserId: "@CurrentUser.Id",
                        ContentId: @Model.Id
                       },
                    success: function (data) {
                        window.location.reload();                    
                    },
                    error: function (error) {
                        console.error("false");
                    }

                });
            });
        });
    </script>


    <script> //remove like
        $(document).ready(function () {

            $("#likedButton").click(function () {
                $.ajax({
                    url: "/Content/RemoveLike",
                    type: "POST",
                    data: {
                        CurUserId: "@CurrentUser.Id",
                        ContentId: @Model.Id
                       },
                    success: function (data) {
                        window.location.reload();
                    },
                    error: function (error) {
                        console.error("false");
                    }

                });
            });
        });
    </script>

}

